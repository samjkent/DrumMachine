#include "ws2812b.h"
#include "tim.h"

// LED mapping required on 0.3 control board
static const uint8_t ledMapping[25] = {2,  9, 16, 0, 6, 13, 20, 4,  10, 17, 1,  8, 14,
                          21, 5, 12, 7, 3, 22, 18, 23, 19, 15, 11, 24};

// Calibration data
static const int16_t on = WS2812B_HIGH;
static const int16_t off = WS2812B_LOW;

// LED state data
uint16_t ledData[760] = {
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0,

    // 1
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 2
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 3
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 4
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 5
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 6
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 7
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 8
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 9
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 10
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 11
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 12
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 13
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 14
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 15
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 16
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 17
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 18
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 19
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 20
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 21
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 22
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 23
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 24
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW,

    // 25
    WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW, WS2812B_LOW

};


void ws2812b_init() {
  MX_TIM8_Init();
  HAL_TIM_PWM_Start_DMA(&htim8, TIM_CHANNEL_2, (uint32_t *)(&ledData[0]), 760);
}

void ws2812b_set_pixel(uint8_t n, uint32_t grb, uint32_t mask) {
  uint8_t m = ledMapping[n];

  // Reverse bit order
  for (int i = 0; i < 24; i++) {
    // Check mask for each bit
    if (((mask >> (i)) & 0x01))
      ledData[160 + (24 * (m + 1)) - (i + 1)] =
          ((grb >> i) & 0x01) ? WS2812B_HIGH : WS2812B_LOW;
  }
}
